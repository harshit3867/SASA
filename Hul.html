<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Zippee ‚Äì Order Status Report</title>

<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
    --primary-900:#003f8c;
    --glass-bg:rgba(255,255,255,0.16);
    --card-shadow:0 8px 30px rgba(0,0,0,0.25);
}

html,body{
    margin:0;
    padding:0;
    font-family:"Segoe UI",Arial;
}

body{
    background:url('Zippee.png') center/cover fixed no-repeat;
}

body::before{
    content:"";
    position:fixed;
    inset:0;
    background:rgba(255,255,255,.24);
    backdrop-filter:blur(6px);
    z-index:-1;
}
/* Used ONLY for PNG export */
.png-export-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    background: #ffffff;
    padding: 30px;
    z-index: 99999;
}

/* ---------- HEADER ---------- */
.header{
    background:linear-gradient(90deg,rgba(0,63,140,.85),rgba(0,89,179,.85));
    color:white;
    padding:18px 36px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.logo{height:48px;}
tr[style*="font-weight: 700"] td{
    font-size:11px;
    padding:4px 6px;
}

/* ---------- CARD ---------- */
.card{
    background:var(--glass-bg);
    backdrop-filter:blur(10px) saturate(120%);
    margin:30px auto;
    max-width:1300px;
    padding:30px;
    border-radius:18px;
    box-shadow:var(--card-shadow);
}

.title{
    font-size:22px;
    font-weight:700;
    color:var(--primary-900);
}

/* ---------- CONTROLS ---------- */
.controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:14px;
}

.button{
    background:linear-gradient(135deg,#0A66C2,#0078FF);
    border:none;
    border-radius:10px;
    padding:10px 18px;
    color:white;
    cursor:pointer;
    font-weight:700;
}

/* ---------- REPORT ---------- */
#reportContainer{margin-top:20px; overflow-x:auto;}
#captureBox{display:inline-block;}

.report-head{text-align:center; margin-bottom:10px;}
.report-title{font-size:18px; font-weight:800;}
.report-meta{font-size:13px;}

/* ---------- TABLE ---------- */
table{
    border-collapse:collapse;
    background:white;
    border-radius:8px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
}

th,td{
    border:1px solid #dcdcdc;
    padding:3px 6px;          /* ‚¨Ö tighter padding */
    white-space:nowrap;
    font-size:11px;           /* ‚¨Ö smaller text */
    text-align:center;
    line-height:1.2;          /* ‚¨Ö tighter rows */
}

th{
    background:#003f8c;
    color:white;
    font-size:11px;           /* ‚¨Ö compact header */
    font-weight:700;
    padding:4px 6px;
}

/* ---------- FOOTER ---------- */
.report-footer{
    display:flex;
    justify-content:center;
    margin:14px 0;
    font-size:12px;
    font-weight:700;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <h1>Zippee ‚Äì Report</h1>
    <img class="logo" src="https://i.imgur.com/7yUVE8U.png">
</div>

<!-- CARD -->
<div class="card">
    <div class="title">Upload Data to Generate Report</div>

    <div class="controls">
        <input type="file" id="fileInput" multiple accept=".xlsx,.xls">
        <button class="button" onclick="processFiles()">Generate Report</button>
        <button class="button" onclick="downloadPNG()">Download PNG</button>
    </div>

    <div id="reportContainer">
        <div id="captureBox">

            <div class="report-head">
                <div class="report-title" id="reportTitle">HUL Report</div>
                <div class="report-meta" id="reportMeta"></div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Sale Order Status</th>
                        <th>Sale Order Item Status</th>
                        <th>Order Date</th>
                        <th>Count of Display Order Code</th>
                    </tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>

            <div class="report-footer">
                Powered by SASA Automation | Harshit Saini - Data Analyst, Zippee
            </div>

        </div>
    </div>
</div>

<script>
function processFiles() {
    const files = document.getElementById("fileInput").files;
    if (!files.length) {
        alert("Please upload at least one Excel file");
        return;
    }

    const pivotMap = {};
    let filesDone = 0;

    for (let file of files) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });

            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

                rows.forEach(row => {
                    const displayOrder = row["Display Order Code"];
                    const orderStatus  = row["Sale Order Status"];
                    const itemStatus   = row["Sale Order Item Status"];
                    const orderDateRaw = row["Order Date as dd/mm/yyyy hh:MM:ss"];

                    if (!displayOrder || !orderStatus || !itemStatus || !orderDateRaw) return;

                    let orderDate = "";
                    if (typeof orderDateRaw === "number") {
                        const base = new Date(Date.UTC(1899,11,30));
                        const d = new Date(base.getTime() + orderDateRaw * 86400000);
                        orderDate =
                            String(d.getUTCDate()).padStart(2,"0") + "/" +
                            String(d.getUTCMonth()+1).padStart(2,"0") + "/" +
                            d.getUTCFullYear();
                    } else {
                        orderDate = String(orderDateRaw).substring(0,10);
                    }

                    const key = orderStatus + "|||" + itemStatus + "|||" + orderDate;
                    if (!pivotMap[key]) pivotMap[key] = new Set();
                    pivotMap[key].add(displayOrder);
                });
            });

            filesDone++;
            if (filesDone === files.length) {
                renderTable(pivotMap);
                setTodayInTitle();
                }
        };

        reader.readAsArrayBuffer(file);
    }
}

function renderTable(pivotMap) {
    const tbody = document.getElementById("resultBody");
    tbody.innerHTML = "";

    let lastStatus = null;
    let lastItemStatus = null;
    let statusTotal = 0;

    const sortedKeys = Object.keys(pivotMap)
    .sort((a,b)=>{
        const [s1,i1,d1]=a.split("|||");
        const [s2,i2,d2]=b.split("|||");

        if(s1!==s2) return s1.localeCompare(s2);
        if(i1!==i2) return i1.localeCompare(i2);
        return d1.split("/").reverse().join("")
            .localeCompare(d2.split("/").reverse().join(""));
    });

    sortedKeys.forEach((key, index) => {
        const [status,item,date] = key.split("|||");
        const count = pivotMap[key].size;

        // üîÅ Sale Order Status changed ‚Üí insert subtotal + reset item
        if (lastStatus !== null && status !== lastStatus) {
const subtotalRow = document.createElement("tr");
subtotalRow.style.fontWeight = "700";
subtotalRow.style.background = " #FFFF00";   // üü® entire row
subtotalRow.innerHTML = `
    <td>${lastStatus} TOTAL</td>
    <td></td>
    <td></td>
    <td>${statusTotal}</td>
`;
tbody.appendChild(subtotalRow);


            statusTotal = 0;
            lastItemStatus = null; // reset item group
        }

        statusTotal += count;

const showStatus = status !== lastStatus;
const showItem = showStatus || item !== lastItemStatus;

// Sale Order Status cell (already correct)
const statusCell = showStatus
    ? `<td style="background:#FFD84D;font-weight:700;">${status}</td>`
    : `<td></td>`;

// üî• Sale Order Item Status cell (NEW)
const itemCell = showItem
    ? `<td style="background:#E2EFDA;font-weight:600;">${item}</td>`  
    : `<td></td>`;

const tr = document.createElement("tr");
tr.innerHTML = `
    ${statusCell}
    ${itemCell}
    <td>${date}</td>
    <td>${count}</td>
`;
tbody.appendChild(tr);



        lastStatus = status;
        lastItemStatus = item;

        // üü¢ Final subtotal at end
        if (index === sortedKeys.length - 1) {
const finalSubtotal = document.createElement("tr");
finalSubtotal.style.fontWeight = "700";
finalSubtotal.style.background = " #FFFF00";  
finalSubtotal.innerHTML = `
    <td>${status} TOTAL</td>
    <td></td>
    <td></td>
    <td>${statusTotal}</td>
`;
tbody.appendChild(finalSubtotal);

        }
    });
}
function setTodayInTitle() {
    const now = new Date();

    const today =
        String(now.getDate()).padStart(2, "0") + "/" +
        String(now.getMonth() + 1).padStart(2, "0") + "/" +
        now.getFullYear();

    document.getElementById("reportTitle").innerText =
        `HUL Report ‚Äì ${today}`;
}


/* ---------- DOWNLOAD PNG ---------- */
function downloadPNG() {
    const original = document.getElementById("captureBox");

    // 1. Clone report
    const clone = original.cloneNode(true);

    // 2. Create clean wrapper (NO blur, NO overlay)
    const wrapper = document.createElement("div");
    wrapper.className = "png-export-wrapper";
    wrapper.appendChild(clone);

    document.body.appendChild(wrapper);

    // 3. Capture the CLEAN wrapper
    html2canvas(wrapper, {
        scale: 2,
        backgroundColor: "#ffffff",
        useCORS: true
    }).then(canvas => {
        const link = document.createElement("a");
        link.download = "Zippee_Report.png";
        link.href = canvas.toDataURL("image/png");
        link.click();

        // 4. Cleanup
        document.body.removeChild(wrapper);
    });
}


</script>

</body>
</html>
