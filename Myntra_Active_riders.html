<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rider Operations Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",sans-serif;
  background:
    linear-gradient(rgba(0,0,0,.75),rgba(0,0,0,.75)),
    url("zippee.png") no-repeat center center fixed;
  background-size:cover;
  color:white;
}

.header{
  text-align:center;
  padding:14px;
  font-size:22px;
  font-weight:700;
}

.container{
  width:95%;
  max-width:1300px;
  margin:auto;
}

/* INPUT */
.store-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:14px;
}

.store-card{
  background:#2f4b66;
  padding:12px;
  border-radius:12px;
}

.store-title{
  font-weight:700;
  margin-bottom:6px;
}

textarea{
  width:100%;
  height:90px;
  border:none;
  border-radius:8px;
  padding:8px;
  font-size:12px;
}

/* BUTTONS */
button{
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}

.action-btn{
  padding:10px 24px;
  background:#0d6efd;
  color:white;
}

.download-btn{
  padding:10px 18px;
  background:#16a34a;
  color:white;
}

/* REPORT */
.report{
  background:white;
  color:black;
  padding:18px;
  border-radius:10px;
  margin-top:20px;
}

.report-title{
  text-align:center;
  font-size:20px;
  font-weight:700;
}

.report-time{
  text-align:center;
  font-size:14px;
  margin:6px 0 12px;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:auto;
}

th{
  background:#c55a11;
  color:white;
  padding:8px;
}

td{
  padding:8px;
  text-align:center;
  border-bottom:1px solid #ddd;
}

.total-row td{
  font-weight:700;
  background:#f1f1f1;
}

.footer{
  text-align:center;
  font-size:12px;
  margin-top:8px;
  color:#333;
}

/* Store name column */
th.store-name,
td.store-name{
  white-space:nowrap;
  padding:8px 10px;
  width:1%;
  text-align:left;
}

/* BF formatting */
.bf-green{background:#dcfce7;color:#166534;font-weight:700}
.bf-yellow{background:#fef9c3;color:#854d0e;font-weight:700}
.bf-red{background:#fee2e2;color:#991b1b;font-weight:700}

/* Difference formatting */
.diff-pos{background:#dcfce7;color:#166534;font-weight:700}
.diff-neg{background:#fee2e2;color:#991b1b;font-weight:700}
</style>
</head>

<body>

<div class="header">SASA Automation</div>

<div class="container">

<!-- TIME -->
<div style="text-align:center;margin-bottom:12px">
  <label style="font-weight:700">Select Time: </label>
  <select id="timeSelect"></select>
</div>

<!-- INPUTS -->
<div class="store-grid" id="storeGrid"></div>

<!-- TOP ACTION BUTTONS -->
<div style="text-align:center;margin:18px 0">
  <button class="action-btn" onclick="generateReports()">Generate Reports</button>
  <button class="download-btn" onclick="downloadBoth()">Download Both Reports</button>
</div>

<!-- BOTH REPORTS WRAPPER (FOR COMBINED PNG) -->
<div id="bothReportsWrapper">

  <!-- REPORT 1 -->
  <div id="report1" class="report" style="display:none">
    <div class="report-title">Active Rider Report</div>
    <div class="report-time" id="timeText1"></div>

    <table>
      <thead>
        <tr>
          <th class="store-name">Darkstore Name</th>
          <th>Active Riders</th>
          <th>Idle Riders</th>
          <th>Pending Orders</th>
          <th>BF</th>
        </tr>
      </thead>
      <tbody id="body1"></tbody>
    </table>

    <div class="footer">
      <b>Powered by SASA Automation | Harshit Saini – Data Analyst, Zippee</b>
    </div>
  </div>

  <!-- REPORT 2 -->
  <div id="report2" class="report" style="display:none">
    <div class="report-title" id="title2"></div>

    <table>
      <thead>
        <tr>
          <th class="store-name">Darkstore Name</th>
          <th>Planned Riders</th>
          <th>Active Riders</th>
          <th>Difference</th>
        </tr>
      </thead>
      <tbody id="body2"></tbody>
    </table>

    <div class="footer">
      <b> Powered by SASA Automation | Harshit Saini – Data Analyst, Zippee </b>
    </div>
  </div>

</div>

<!-- BOTTOM DOWNLOAD BUTTONS (NOT CAPTURED) -->
<div style="text-align:center;margin:20px 0 40px">
  <button class="download-btn" onclick="download('report1','Active_Rider_Report.png')">
    Download Report 1
  </button>
  <button class="download-btn" onclick="download('report2','Planned_Rider_Report.png')">
    Download Report 2
  </button>
</div>

</div>

<script>
/* TIME */
const timeSelect=document.getElementById("timeSelect");
const hours=[
"6:00 AM","7:00 AM","8:00 AM","9:00 AM","10:00 AM","11:00 AM",
"12:00 PM","1:00 PM","2:00 PM","3:00 PM","4:00 PM","5:00 PM",
"6:00 PM","7:00 PM","8:00 PM","9:00 PM","10:00 PM"
];
hours.forEach(h=>{
  const o=document.createElement("option");
  o.value=h;o.textContent=h;
  timeSelect.appendChild(o);
});
const now=new Date();
timeSelect.value=`${now.getHours()%12||12}:00 ${now.getHours()<12?"AM":"PM"}`;

/* STORES */
const stores=[
"Kalyan Nagar Mnow","Basaveshwar Nagar Mnow","Jakkur Mnow","Begur Mnow",
"Thyagaraja Nagar Mnow","Brookfield Mnow","Hulimavu Mnow","Sarjapur Road Mnow",
"Manikonda Mnow","Gachibowli Mnow","Attapur Mnow","Nizampet Mnow"
];

const grid=document.getElementById("storeGrid");
stores.forEach(s=>{
  grid.innerHTML+=`
  <div class="store-card">
    <div class="store-title">${s}</div>
    <textarea id="${s}"></textarea>
  </div>`;
});

/* CSV */
let plannedData={};
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSZ-18de0srb6yUjkIVdVlZkZqzNAPD6XcLC8ZFPckoyAjTLxgpLekUd4KHoX95M2oqZP5ZUF9b19kQ/pub?gid=0&single=true&output=csv")
.then(r=>r.text())
.then(t=>{
  const rows=t.split("\n").map(r=>r.split(","));
  const headers=rows[0];
  rows.slice(1).forEach(r=>{
    plannedData[r[0]]={};
    headers.slice(1).forEach((h,i)=>{
      plannedData[r[0]][h]=parseInt(r[i+1])||0;
    });
  });
});

/* HELPERS */
function bfClass(bf){
  if(bf>2) return "bf-red";
  if(bf>1.7) return "bf-yellow";
  return "bf-green";
}

/* GENERATE */
function generateReports(){
  const time=timeSelect.value;
  document.getElementById("timeText1").innerText=`Time: ${time}`;
  document.getElementById("title2").innerText=`Planned Rider Report – Time: ${time}`;

  const b1=document.getElementById("body1");
  const b2=document.getElementById("body2");
  b1.innerHTML=""; b2.innerHTML="";

  let tA=0,tI=0,tP=0,tBF=0,c=0;
  let pPlan=0,pAct=0,pDiff=0;

  stores.forEach(s=>{
    const lines=document.getElementById(s).value.split("\n").map(l=>l.trim());
    let ar=0,bf=0,inst=[],un=0;

    lines.forEach((l,i)=>{
      if(l==="No. of Active Riders") ar=parseInt(lines[i-1])||0;
      if(l==="Banner Factor") bf=parseFloat(lines[i-1])||0;
      if(l==="In Store") inst.push(parseInt(lines[i+1])||0);
      if(l==="Unassigned") un=parseInt(lines[i+1])||0;
    });

    const idle=inst[1]||0;
    const pending=(inst[0]||0)+un;

    tA+=ar;tI+=idle;tP+=pending;
    if(bf){tBF+=bf;c++;}

    b1.innerHTML+=`
    <tr>
      <td class="store-name">${s}</td>
      <td>${ar}</td>
      <td>${idle}</td>
      <td>${pending}</td>
      <td class="${bfClass(bf)}">${bf.toFixed(2)}</td>
    </tr>`;

    const planned=plannedData[s]?.[time]||0;
    const diff=ar-planned;

    pPlan+=planned;pAct+=ar;pDiff+=diff;

    b2.innerHTML+=`
    <tr>
      <td class="store-name">${s}</td>
      <td>${planned}</td>
      <td>${ar}</td>
      <td class="${diff>0?"diff-pos":diff<0?"diff-neg":""}">${diff}</td>
    </tr>`;
  });

  b1.innerHTML+=`
  <tr class="total-row">
    <td class="store-name">Total</td>
    <td>${tA}</td>
    <td>${tI}</td>
    <td>${tP}</td>
    <td class="${bfClass(tBF/c)}">${(tBF/c).toFixed(2)}</td>
  </tr>`;

  b2.innerHTML+=`
  <tr class="total-row">
    <td class="store-name">Total</td>
    <td>${pPlan}</td>
    <td>${pAct}</td>
    <td class="${pDiff>0?"diff-pos":pDiff<0?"diff-neg":""}">${pDiff}</td>
  </tr>`;

  document.getElementById("report1").style.display="block";
  document.getElementById("report2").style.display="block";
}

/* DOWNLOAD */
function download(id,name){
  html2canvas(document.getElementById(id),{scale:4,useCORS:true}).then(c=>{
    const a=document.createElement("a");
    a.href=c.toDataURL();
    a.download=name;
    a.click();
  });
}

function downloadBoth(){
  // Download Report 1
  html2canvas(document.getElementById("report1"),{
    scale:4,
    useCORS:true
  }).then(canvas1=>{
    const a1=document.createElement("a");
    a1.href=canvas1.toDataURL("image/png");
    a1.download="Active_Rider_Report.png";
    a1.click();

    // After first download, download Report 2
    html2canvas(document.getElementById("report2"),{
      scale:4,
      useCORS:true
    }).then(canvas2=>{
      const a2=document.createElement("a");
      a2.href=canvas2.toDataURL("image/png");
      a2.download="Planned_Rider_Report.png";
      a2.click();
    });
  });
}

</script>

</body>
</html>

