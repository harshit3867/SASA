<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rider Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,sans-serif;
  background:
    linear-gradient(rgba(0,0,0,.75),rgba(0,0,0,.75)),
    url("zippee.png") no-repeat center center fixed;
  background-size:cover;
  color:#fff;
}
.header{text-align:center;padding:14px;font-size:22px;font-weight:700}
.container{width:95%;margin:auto}

.store-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:10px;
}
.store-card{background:#2f4b66;padding:8px;border-radius:8px}
.store-title{font-size:13px;font-weight:700;margin-bottom:4px;text-align:center}
textarea{width:100%;height:80px;border:none;border-radius:6px;padding:6px;font-size:12px}

button{border:none;border-radius:6px;cursor:pointer;font-weight:700}
.action-btn{background:#0d6efd;color:white;padding:8px 18px}
.download-btn{background:#16a34a;color:white;padding:8px 16px}

.report{
  background:white;
  color:black;
  padding:12px;
  border-radius:8px;
  margin:20px auto;
  max-width:20cm;
}
.report-title{text-align:center;font-size:18px;font-weight:700}
.report-time{text-align:center;font-size:13px;margin:4px 0 8px}

table{width:100%;border-collapse:collapse}
th,td{
  padding:4px 6px;
  font-size:13px;
  border-bottom:1px solid #ddd;
  text-align:center;
  white-space:nowrap;
}
th{background:#c55a11;color:white;font-weight:700}
.total-row td{background:#f2f2f2;font-weight:700}

.bf-green{background:#dcfce7;color:#166534;font-weight:700}
.bf-yellow{background:#fef9c3;color:#854d0e;font-weight:700}
.bf-red{background:#fee2e2;color:#991b1b;font-weight:700}
.diff-pos{background:#dcfce7;color:#166534;font-weight:700}
.diff-neg{background:#fee2e2;color:#991b1b;font-weight:700}

.footer{text-align:center;font-size:11px;margin-top:6px;color:#333}
</style>
</head>

<body>

<div class="header">SASA Automation</div>

<div class="container">

<!-- TIME SELECT (12 HOUR FORMAT) -->
<div style="text-align:center;margin-bottom:10px">
  <label><b>Hour:</b></label>
  <select id="hourSelect"></select>

  <label style="margin-left:8px"><b>Min:</b></label>
  <select id="minSelect">
    <option value="">--</option>
    <option value="00">00</option>
    <option value="15">15</option>
    <option value="30">30</option>
    <option value="45">45</option>
  </select>

  <label style="margin-left:8px"><b>AM/PM:</b></label>
  <select id="ampmSelect">
    <option value="AM">AM</option>
    <option value="PM">PM</option>
  </select>
</div>

<div class="store-grid" id="storeGrid"></div>

<div style="text-align:center;margin:14px 0">
  <button class="action-btn" onclick="generate()">Generate Reports</button>
  <button class="download-btn" onclick="downloadBoth()">Download Both Reports</button>
  <button class="download-btn" onclick="copySummary()">Copy Active + Idle + BF</button>
</div>

<!-- REPORT 1 -->
<div id="report1" class="report" style="display:none">
  <div class="report-title">Active Rider Report</div>
  <div class="report-time" id="time1"></div>
  <table>
    <thead>
      <tr>
        <th>Darkstore Name</th>
        <th>Active Riders</th>
        <th>Idle Riders</th>
        <th>Pending Orders</th>
        <th>BF</th>
      </tr>
    </thead>
    <tbody id="body1"></tbody>
  </table>
  <div class="footer"><b>Powered by SASA Automation | Harshit Saini â€“ Data Analyst, Zippee</b></div>
</div>

<!-- REPORT 2 -->
<div id="report2" class="report" style="display:none">
  <div class="report-title" id="title2"></div>
  <table>
    <thead>
      <tr>
        <th>Darkstore Name</th>
        <th>Planned Riders</th>
        <th>Active Riders</th>
        <th>Difference</th>
      </tr>
    </thead>
    <tbody id="body2"></tbody>
  </table>
  <div class="footer"><b>Powered by SASA Automation | Harshit Saini â€“ Data Analyst, Zippee</b></div>
</div>

<div style="text-align:center;margin:18px 0">
  <button class="download-btn" onclick="downloadSingle('report1','Active_Rider_Report.png')">Download Report 1</button>
  <button class="download-btn" onclick="downloadSingle('report2','Planned_Rider_Report.png')">Download Report 2</button>
</div>

</div>

<script>
/* ===== TIME SETUP (12 HOUR) ===== */
const hourSel=document.getElementById("hourSelect");
const minSel=document.getElementById("minSelect");
const ampmSel=document.getElementById("ampmSelect");

for(let h=1;h<=12;h++){
  hourSel.add(new Option(h,h));
}

/* auto set current time */
const now=new Date();
let ch=now.getHours();
ampmSel.value=ch>=12?"PM":"AM";
ch=ch%12||12;
hourSel.value=ch;
minSel.value="";

/* ===== STORES ===== */
const stores=[
"Kalyan Nagar Mnow","Basaveshwar Nagar Mnow","Jakkur Mnow","Begur Mnow",
"Thyagaraja Nagar Mnow","Brookfield Mnow","Hulimavu Mnow","Sarjapur Road Mnow",
"Manikonda Mnow","Gachibowli Mnow","Attapur Mnow","Nizampet Mnow"
];
const grid=document.getElementById("storeGrid");
stores.forEach(s=>{
  grid.innerHTML+=`
    <div class="store-card">
      <div class="store-title">${s}</div>
      <textarea id="${s}"></textarea>
    </div>`;
});

/* ===== PLANNED CSV ===== */
let planned={};
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSZ-18de0srb6yUjkIVdVlZkZqzNAPD6XcLC8ZFPckoyAjTLxgpLekUd4KHoX95M2oqZP5ZUF9b19kQ/pub?gid=0&single=true&output=csv")
.then(r=>r.text())
.then(t=>{
  const rows=t.split("\n").map(r=>r.split(","));
  const h=rows[0];
  rows.slice(1).forEach(r=>{
    planned[r[0]]={};
    h.slice(1).forEach((x,i)=>planned[r[0]][x]=parseInt(r[i+1])||0);
  });
});

/* ===== HELPERS ===== */
const bfCls=v=>v>2?"bf-red":v>1.7?"bf-yellow":"bf-green";

/* ===== GENERATE ===== */
function generate(){
  const h=hourSel.value;
  const m=minSel.value||"00";
  const ap=ampmSel.value;

  const displayTime=`${h}:${m} ${ap}`;
  const planTime=`${h}:00 ${ap}`;

  time1.innerText=`Time: ${displayTime}`;
  title2.innerText=`Planned Rider Report â€“ Time: ${displayTime}`;

  body1.innerHTML=""; body2.innerHTML="";
  let ta=0,ti=0,tp=0,tbf=0,c=0,pp=0,pa=0,pd=0;

  stores.forEach(s=>{
    const l=document.getElementById(s).value.split("\n").map(x=>x.trim());
    let a=0,b=0,i=[],u=0;

    l.forEach((x,j)=>{
      if(x==="No. of Active Riders") a=+l[j-1]||0;
      if(x==="Banner Factor") b=parseFloat(l[j-1])||0;
      if(x==="In Store") i.push(+l[j+1]||0);
      if(x==="Unassigned") u=+l[j+1]||0;
    });

    const idle=i[1]||0,p=(i[0]||0)+u;
    ta+=a;ti+=idle;tp+=p;if(b){tbf+=b;c++}

    body1.innerHTML+=`
      <tr>
        <td>${s}</td><td>${a}</td><td>${idle}</td><td>${p}</td>
        <td class="${bfCls(b)}">${b.toFixed(2)}</td>
      </tr>`;

    const pl=planned[s]?.[planTime]||0;
    const d=a-pl;
    pp+=pl;pa+=a;pd+=d;

    body2.innerHTML+=`
      <tr>
        <td>${s}</td><td>${pl}</td><td>${a}</td>
        <td class="${d>0?"diff-pos":d<0?"diff-neg":""}">${d}</td>
      </tr>`;
  });

  body1.innerHTML+=`
    <tr class="total-row">
      <td>Total</td><td>${ta}</td><td>${ti}</td><td>${tp}</td>
      <td class="${bfCls(tbf/c)}">${(tbf/c).toFixed(2)}</td>
    </tr>`;

  body2.innerHTML+=`
    <tr class="total-row">
      <td>Total</td><td>${pp}</td><td>${pa}</td>
      <td class="${pd>0?"diff-pos":pd<0?"diff-neg":""}">${pd}</td>
    </tr>`;

  report1.style.display="block";
  report2.style.display="block";
}
function copySummary(){
  let text = "";

  stores.forEach(s=>{
    const l=document.getElementById(s).value.split("\n").map(x=>x.trim());
    let a=0,b=0,i=[];

    l.forEach((x,j)=>{
      if(x==="No. of Active Riders") a=+l[j-1]||0;
      if(x==="Banner Factor") b=parseFloat(l[j-1])||0;
      if(x==="In Store") i.push(+l[j+1]||0);
    });

    const idle=i[1]||0;

    text += `${a}\t${idle}\t${b.toFixed(2)}\n`;
  });

  navigator.clipboard.writeText(text.trim())
  .then(()=> alert("Copied Successfully âœ…"))
  .catch(()=> alert("Copy failed âŒ"));
}

/* ===== DOWNLOAD ===== */
function downloadSingle(id,name){
  requestAnimationFrame(()=>{
    html2canvas(document.getElementById(id),{scale:4,backgroundColor:"#fff"})
    .then(c=>{
      const a=document.createElement("a");
      a.href=c.toDataURL("image/png");
      a.download=name;
      a.click();
    });
  });
}
function downloadBoth(){
  downloadSingle("report1","Active_Rider_Report.png");
  setTimeout(()=>downloadSingle("report2","Planned_Rider_Report.png"),700);
}
</script>
<script>
/* ------------- SCREENSHOT / COPY DETERRENCE -------------- */

/* Temporary Blur Overlay */
function temporarilyBlur() {
    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.inset = "0";
    overlay.style.backdropFilter = "blur(18px)";
    overlay.style.background = "rgba(255,255,255,0.25)";
    overlay.style.zIndex = "999999";
    overlay.style.pointerEvents = "none";
    document.body.appendChild(overlay);
    setTimeout(()=> overlay.remove(), 1400);
}

/* Windows Snipping Tool (Win + Shift + S fallback detection) */
document.addEventListener("keydown", function(e){
    if (e.shiftKey && e.metaKey) {
        temporarilyBlur();
    }

    if (e.shiftKey && e.key.toLowerCase() === "s") {
        temporarilyBlur();
    }
});

/* Mac Screenshot */
document.addEventListener("keydown", function(e){
    if (e.metaKey && e.shiftKey && (e.key === "3" || e.key === "4")) {
        e.preventDefault();
        temporarilyBlur();
        alert("Mac screenshot shortcut blocked.");
    }
});

/* Disable right-click, select, copy */
document.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("selectstart", e => e.preventDefault());
document.addEventListener("copy", e => {
    e.preventDefault();
    alert("Copying is disabled on this page.");
});

/* ------------- ANTI-INSPECT / DEVTOOLS -------------- */

/* Detect DevTools */
setInterval(function () {
  const threshold = 160;
  if (
    window.outerWidth - window.innerWidth > threshold ||
    window.outerHeight - window.innerHeight > threshold
  ) {
    document.body.innerHTML =
      "<h2 style='text-align:center;margin-top:40px;'>Dev Tools are not allowed ðŸš«</h2>";
  }
}, 500);

/* Block Inspect Keys */
document.addEventListener("keydown", function(e){

  // F12
  if (e.keyCode === 123) e.preventDefault();

  // Ctrl + Shift + I / J / C
  if (e.ctrlKey && e.shiftKey &&
     ['I','J','C','i','j','c'].includes(e.key)) {
      e.preventDefault();
  }

  // Ctrl + U
  if (e.ctrlKey && ['U','u'].includes(e.key)) {
      e.preventDefault();
  }

  // Block any Ctrl + Shift combo
  if (e.ctrlKey && e.shiftKey) e.preventDefault();
});
</script>

</body>
</html>
