<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rider Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,sans-serif;
  background:
    linear-gradient(rgba(0,0,0,.75),rgba(0,0,0,.75)),
    url("Zippee.png") no-repeat center center fixed;
  background-size:cover;
  color:#fff;
}

.header{
  text-align:center;
  padding:14px;
  font-size:22px;
  font-weight:700;
}

.container{
  width:95%;
  margin:auto;
}

/* INPUT */
.store-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:10px;
}

.store-card{
  background:#2f4b66;
  padding:8px;
  border-radius:8px;
}

.store-title{
  font-size:13px;
  font-weight:700;
  margin-bottom:4px;
  text-align:center;
}

textarea{
  width:100%;
  height:80px;
  border:none;
  border-radius:6px;
  padding:6px;
  font-size:12px;
}

/* BUTTONS */
button{
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:700;
}

.action-btn{
  background:#0d6efd;
  color:white;
  padding:8px 18px;
}

.download-btn{
  background:#16a34a;
  color:white;
  padding:8px 16px;
}

/* ===== REPORT (20 CM MAX) ===== */
.report{
  background:white;
  color:black;
  padding:12px;
  border-radius:8px;
  margin:20px auto;
  max-width:20cm;        /* ðŸ”’ HARD LIMIT */
}

.report-title{
  text-align:center;
  font-size:18px;
  font-weight:700;
}

.report-time{
  text-align:center;
  font-size:13px;
  margin:4px 0 8px;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:auto;
}

th,td{
  padding:4px 6px;
  font-size:13px;
  border-bottom:1px solid #ddd;
  text-align:center;     /* ðŸ”’ CENTER EVERYTHING */
  white-space:nowrap;
}

th{
  background:#c55a11;
  color:white;
  font-weight:700;
}

.total-row td{
  background:#f2f2f2;
  font-weight:700;
}

/* BF conditional */
.bf-green{background:#dcfce7;color:#166534;font-weight:700}
.bf-yellow{background:#fef9c3;color:#854d0e;font-weight:700}
.bf-red{background:#fee2e2;color:#991b1b;font-weight:700}

/* Difference conditional */
.diff-pos{background:#dcfce7;color:#166534;font-weight:700}
.diff-neg{background:#fee2e2;color:#991b1b;font-weight:700}

.footer{
  text-align:center;
  font-size:11px;
  margin-top:6px;
  color:#333;
}
</style>
</head>

<body>

<div class="header">SASA Automation</div>

<div class="container">

<div style="text-align:center;margin-bottom:10px">
  <label><b>Select Time:</b></label>
  <select id="timeSelect"></select>
</div>

<div class="store-grid" id="storeGrid"></div>

<div style="text-align:center;margin:14px 0">
  <button class="action-btn" onclick="generate()">Generate Reports</button>
  <button class="download-btn" onclick="downloadBoth()">Download Both Reports</button>
</div>

<!-- REPORT 1 -->
<div id="report1" class="report" style="display:none">
  <div class="report-title">Active Rider Report</div>
  <div class="report-time" id="time1"></div>

  <table>
    <thead>
      <tr>
        <th>Darkstore Name</th>
        <th>Active Riders</th>
        <th>Idle Riders</th>
        <th>Pending Orders</th>
        <th>BF</th>
      </tr>
    </thead>
    <tbody id="body1"></tbody>
  </table>

  <div class="footer"><b>Powered by SASA Automation | Harshit Saini â€“ Data Analyst, Zippee</b></div>
</div>

<!-- REPORT 2 -->
<div id="report2" class="report" style="display:none">
  <div class="report-title" id="title2"></div>

  <table>
    <thead>
      <tr>
        <th>Darkstore Name</th>
        <th>Planned Riders</th>
        <th>Active Riders</th>
        <th>Difference</th>
      </tr>
    </thead>
    <tbody id="body2"></tbody>
  </table>

  <div class="footer"><b>Powered by SASA Automation | Harshit Saini â€“ Data Analyst, Zippee</b></div>
</div>

<div style="text-align:center;margin:18px 0">
  <button class="download-btn" onclick="downloadSingle('report1','Active_Rider_Report.png')">Download Report 1</button>
  <button class="download-btn" onclick="downloadSingle('report2','Planned_Rider_Report.png')">Download Report 2</button>
</div>

</div>

<script>
/* TIME */
const times=[
"12:00 AM","1:00 AM","2:00 AM","3:00 AM","4:00 AM","5:00 AM",
"6:00 AM","7:00 AM","8:00 AM","9:00 AM","10:00 AM","11:00 AM",
"12:00 PM","1:00 PM","2:00 PM","3:00 PM","4:00 PM","5:00 PM",
"6:00 PM","7:00 PM","8:00 PM","9:00 PM","10:00 PM"
];
const ts=document.getElementById("timeSelect");
times.forEach(t=>ts.add(new Option(t,t)));
const n=new Date();
ts.value=`${n.getHours()%12||12}:00 ${n.getHours()<12?"AM":"PM"}`;

/* STORES */
const stores=[
"Kalyan Nagar Mnow","Basaveshwar Nagar Mnow","Jakkur Mnow","Begur Mnow",
"Thyagaraja Nagar Mnow","Brookfield Mnow","Hulimavu Mnow","Sarjapur Road Mnow",
"Manikonda Mnow","Gachibowli Mnow","Attapur Mnow","Nizampet Mnow"
];
const grid=document.getElementById("storeGrid");
stores.forEach(s=>{
  grid.innerHTML+=`
    <div class="store-card">
      <div class="store-title">${s}</div>
      <textarea id="${s}"></textarea>
    </div>`;
});

/* CSV */
let planned={};
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSZ-18de0srb6yUjkIVdVlZkZqzNAPD6XcLC8ZFPckoyAjTLxgpLekUd4KHoX95M2oqZP5ZUF9b19kQ/pub?gid=0&single=true&output=csv")
.then(r=>r.text())
.then(t=>{
  const rows=t.split("\n").map(r=>r.split(","));
  const h=rows[0];
  rows.slice(1).forEach(r=>{
    planned[r[0]]={};
    h.slice(1).forEach((x,i)=>planned[r[0]][x]=parseInt(r[i+1])||0);
  });
});

/* HELPERS */
const bfCls=v=>v>2?"bf-red":v>1.7?"bf-yellow":"bf-green";

/* GENERATE */
function generate(){
  const time=ts.value;
  time1.innerText=`Time: ${time}`;
  title2.innerText=`Planned Rider Report â€“ Time: ${time}`;
  body1.innerHTML=""; body2.innerHTML="";

  let ta=0,ti=0,tp=0,tbf=0,c=0,pp=0,pa=0,pd=0;

  stores.forEach(s=>{
    const l=document.getElementById(s).value.split("\n").map(x=>x.trim());
    let a=0,b=0,i=[],u=0;
    l.forEach((x,j)=>{
      if(x==="No. of Active Riders") a=+l[j-1]||0;
      if(x==="Banner Factor") b=parseFloat(l[j-1])||0;
      if(x==="In Store") i.push(+l[j+1]||0);
      if(x==="Unassigned") u=+l[j+1]||0;
    });
    const idle=i[1]||0,p=(i[0]||0)+u;
    ta+=a;ti+=idle;tp+=p;if(b){tbf+=b;c++}

    body1.innerHTML+=`
      <tr>
        <td>${s}</td><td>${a}</td><td>${idle}</td><td>${p}</td>
        <td class="${bfCls(b)}">${b.toFixed(2)}</td>
      </tr>`;

    const pl=planned[s]?.[time]||0,d=a-pl;
    pp+=pl;pa+=a;pd+=d;

    body2.innerHTML+=`
      <tr>
        <td>${s}</td><td>${pl}</td><td>${a}</td>
        <td class="${d>0?"diff-pos":d<0?"diff-neg":""}">${d}</td>
      </tr>`;
  });

  body1.innerHTML+=`
    <tr class="total-row">
      <td>Total</td><td>${ta}</td><td>${ti}</td><td>${tp}</td>
      <td class="${bfCls(tbf/c)}">${(tbf/c).toFixed(2)}</td>
    </tr>`;

  body2.innerHTML+=`
    <tr class="total-row">
      <td>Total</td><td>${pp}</td><td>${pa}</td>
      <td class="${pd>0?"diff-pos":pd<0?"diff-neg":""}">${pd}</td>
    </tr>`;

  report1.style.display="block";
  report2.style.display="block";
}

/* DOWNLOAD */
function downloadSingle(id,name){
  requestAnimationFrame(()=>{
    html2canvas(document.getElementById(id),{scale:4,backgroundColor:"#fff"})
    .then(c=>{
      const a=document.createElement("a");
      a.href=c.toDataURL("image/png");
      a.download=name;
      a.click();
    });
  });
}
function downloadBoth(){
  downloadSingle("report1","Active_Rider_Report.png");
  setTimeout(()=>downloadSingle("report2","Planned_Rider_Report.png"),700);
}
</script>

</body>
</html>


