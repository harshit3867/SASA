<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inventory Report</title>

<!-- CSV + EXCEL LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>

/* ========= THEME VARIABLES ========= */
:root{
    --zippee-primary:#00305E;
    --zippee-secondary:#0078D4;
    --text-dark:#1d2a38;
    --card-bg:rgba(255,255,255,.18);
}

body.dark{
    --zippee-primary:#dce9ff;
    --text-dark:#f5f5f5;
    --card-bg:rgba(0,0,0,.35);
    background:#0b1320 !important;
}

/* ========= GLOBAL BACKGROUND ========= */
body{
    margin:0;
    font-family:"Segoe UI",sans-serif;
    background:url('Zippee.png') no-repeat center/cover;
    min-height:100vh;
    overflow-x:hidden;
    color:var(--text-dark);
}

body::before{
    content:"";
    position:fixed;
    inset:0;
    background:rgba(255,255,255,.25);
    z-index:-1;
}

/* ========= HEADER ========= */
.header-main{
    background:rgba(0,48,94,.88);
    color:white;
    position:fixed;
    top:0;
    width:100%;
    padding:10px 10px;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    z-index:20;
}

h1{
    margin:0;
    font-size:20px;
}

/* ========= DARK MODE TOGGLE ========= */
.toggle-dark{
    position:fixed;
    top:10px;
    right:15px;
    background:white;
    border-radius:50px;
    padding:6px 12px;
    cursor:pointer;
    font-size:14px;
    z-index:50;
}

/* ========= MAIN CARD CONTAINER ========= */
.container{
    margin:115px auto 60px auto;
    width:92%;
    max-width:1100px;
    padding:26px 22px;
    border-radius:18px;
    background:var(--card-bg);
    backdrop-filter:blur(10px);
    box-shadow:0 8px 28px rgba(0,0,0,.25);
}

/* ========= INPUT & BUTTON STYLES ========= */
input[type=file]{
    padding:8px 6px;
    border-radius:8px;
    border:1px solid #ccc;
    background:white;
}

button{
    background:linear-gradient(135deg,#0A66C2,#0078FF);
    color:white;
    padding:10px 16px;
    border-radius:10px;
    border:none;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.25);
}

button:hover{
    transform:translateY(-2px);
}

/* ========= TABLE WRAPPER ========= */
.table-wrapper{
    max-width: 100%;
    margin: 0 auto 18px auto;
    max-height: 400px;
    overflow-y: auto;
    border-radius: 14px;
    box-shadow:0 2px 14px rgba(0,0,0,0.15);
}

/* ========= TABLE STYLING ========= */
table{
  border-collapse: collapse;
  width: 100%;
  backdrop-filter:blur(4px);
}

th, td{
  border: 1px solid rgba(0,0,0,0.25);
  padding: 8px 10px;
  text-align: left;
  white-space: nowrap;
}

th{
  background:rgba(0,48,94,.12);
  font-weight: bold;
}

.subtotal{
  font-weight: bold;
  background: rgba(0,120,255,0.12);
}

/* ========= SECTION HEADINGS ========= */
.section-title{
    text-align:center;
    font-size:19px;
    margin-top:14px;
}

</style>
</head>

<body>

<!-- DARK MODE BUTTON -->
<div class="toggle-dark" onclick="document.body.classList.toggle('dark')">üåô / ‚òÄÔ∏è</div>

<!-- HEADER -->
<div class="header-main">
    <h1>Inventory Report</h1>
</div>

<!-- MAIN CONTAINER -->
<div class="container">

    <h2 style="text-align:center">Upload Files</h2>

    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" multiple>
    <br><br>

    <!-- IMPORTANT: type=button -->
    <button type="button" onclick="downloadExcel()">Download Excel</button>

    <hr>

    <h3 class="section-title">Detailed City‚ÄìFSN‚ÄìATP Table</h3>

    <div class="table-wrapper">
        <table id="resultTable">
            <thead>
            <tr>
              <th>City</th>
              <th>FSN</th>
              <th>ATP</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h3 class="section-title">City-wise Unique FSN Count</h3>

    <div class="table-wrapper">
        <table id="summaryTable">
            <thead>
            <tr>
              <th>City</th>
              <th>Unique FSN Count</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>

/* -------- CITY LOGIC ---------- */
function detectCity(h){
    if(!h) return "Unknown";
    h = h.toLowerCase();

    if(h.includes("mrd") || h.includes("mor")) return "Moradabad";
    if(h.includes("ahd")) return "Allahabad";
    if(h.includes("nsk")) return "Nasik";
    if(h.includes("sil") || h.includes("slg")) return "Siliguri";
    if(h.includes("sur") || h.includes("str")) return "Surat";
    if(h.includes("vdr")) return "Vadodara";

    return "Unknown";
}

// STORAGE
let combinedRows = [];
let renderedDataForExcel = [];

document.getElementById("fileInput").addEventListener("change", async function(e){

    combinedRows = [];

    const files = Array.from(e.target.files);

    for(const file of files){
        const ext = file.name.split(".").pop().toLowerCase();

        if(ext === "csv"){
            await handleCSV(file);
        } else {
            await handleExcel(file);
        }
    }

    renderTables();
});

// NORMALIZE FSN
function normalizeFSN(v){
    if(!v) return "";
    return String(v).trim().toUpperCase();
}

// ---- CSV ----
function handleCSV(file){
    return new Promise(resolve => {
        Papa.parse(file, {
            header: false,
            skipEmptyLines: true,
            complete: function(result){

                const rows = result.data;

                rows.slice(1).forEach(r=>{
                    combinedRows.push([
                        detectCity(r[0]),
                        normalizeFSN(r[3]),
                        Number(r[14]) || 0
                    ]);
                });

                resolve();
            }
        });
    });
}

// ---- EXCEL ----
function handleExcel(file){
    return new Promise(resolve => {
        const reader = new FileReader();

        reader.onload = function(e){
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type:'array'});

            workbook.SheetNames.forEach(sheetName => {
                const ws = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(ws, {header:1});

                json.slice(1).forEach(r=>{
                    combinedRows.push([
                        detectCity(r[0]),
                        normalizeFSN(r[3]),
                        Number(r[14]) || 0
                    ]);
                });
            });

            resolve();
        };

        reader.readAsArrayBuffer(file);
    });
}

// ---- RENDER TABLES ----
function renderTables(){

    const byCity = {};

    combinedRows.forEach(r=>{
        const city = r[0];
        if(!byCity[city]) byCity[city] = [];
        byCity[city].push(r);
    });

    // DETAIL TABLE
    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";

    renderedDataForExcel = [["City","FSN","ATP"]];

    Object.keys(byCity).forEach(city => {

        let subtotal = 0;

        byCity[city].forEach(r=>{
            subtotal += Number(r[2]) || 0;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${r[0]}</td>
                <td>${r[1]}</td>
                <td>${r[2]}</td>
            `;
            tbody.appendChild(tr);

            renderedDataForExcel.push([r[0], r[1], r[2]]);
        });

        const sub = document.createElement("tr");
        sub.className = "subtotal";
        sub.innerHTML = `
            <td>${city} Subtotal</td>
            <td></td>
            <td>${subtotal}</td>
        `;
        tbody.appendChild(sub);

        renderedDataForExcel.push([`${city} Subtotal`, "", subtotal]);
    });

    // SUMMARY UNIQUE FSN COUNT
    const summaryBody = document.querySelector("#summaryTable tbody");
    summaryBody.innerHTML = "";

    Object.keys(byCity).forEach(city =>{

        const fsnSet = new Set();

        byCity[city].forEach(r=>{
            const fsn = normalizeFSN(r[1]);
            if(fsn) fsnSet.add(fsn);
        });

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${city}</td>
            <td>${fsnSet.size}</td>
        `;
        summaryBody.appendChild(tr);
    });
}

// ---- DOWNLOAD ----
function downloadExcel(){

    if(renderedDataForExcel.length === 0){
        alert("Please upload files first.");
        return;
    }

    const wb = XLSX.utils.book_new();

    // DETAILS
    const ws1 = XLSX.utils.aoa_to_sheet(renderedDataForExcel);
    XLSX.utils.book_append_sheet(wb, ws1, "Details");

    // SUMMARY
    const cityCounts = {};
    combinedRows.forEach(r=>{
        const city = r[0];
        const fsn = normalizeFSN(r[1]);
        if(!cityCounts[city]) cityCounts[city] = new Set();
        if(fsn) cityCounts[city].add(fsn);
    });

    const summarySheetData = [["City","Unique FSN Count"]];
    Object.keys(cityCounts).forEach(city=>{
        summarySheetData.push([city, cityCounts[city].size]);
    });

    const ws2 = XLSX.utils.aoa_to_sheet(summarySheetData);
    XLSX.utils.book_append_sheet(wb, ws2, "Citywise_Unique_FSN");

    // IMPORTANT POLYFILL FOR ALL BROWSERS
    if (!XLSX.writeFile && XLSX.writeFileXLSX) {
        XLSX.writeFile = XLSX.writeFileXLSX;
    }

    XLSX.writeFile(wb, "city_fsn_atp_report.xlsx");
}

</script>

</body>
</html>
